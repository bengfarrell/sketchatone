#!/bin/bash
# Sketchatone Setup Script
# Configures auto-start mode and generates udev rules from device configs

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
print_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
print_error() { echo -e "${RED}[ERROR]${NC} $1"; }
print_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }

# Default paths
INSTALL_DIR="/opt/sketchatone"
CONFIG_DIR="$INSTALL_DIR/configs"
DEVICES_DIR="$CONFIG_DIR/devices"
UDEV_RULES_FILE="/etc/udev/rules.d/99-sketchatone.rules"
SERVICE_FILE="/etc/systemd/system/sketchatone.service"

# Show usage
show_usage() {
    cat << USAGE
Sketchatone Setup Script

Usage: $0 [OPTIONS]

Options:
    --mode <mode>       Set auto-start mode:
                          usb-trigger  - Start when tablet is plugged in (recommended)
                          always-on    - Start on system boot
                          manual       - No auto-start, run manually
    
    --list-devices      List detected device configs and their vendor/product IDs
    --status            Show current configuration status
    --help              Show this help message

Examples:
    $0 --mode usb-trigger    # Auto-start when tablet is plugged in
    $0 --mode always-on      # Traditional always-running service
    $0 --mode manual         # Disable auto-start
    $0 --list-devices        # Show available device configs
    $0 --status              # Show current setup

USAGE
}

# Check if running as root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        print_error "This script must be run as root (use sudo)"
        exit 1
    fi
}

# Check if sketchatone is installed
check_installed() {
    if [ ! -d "$INSTALL_DIR" ]; then
        print_error "Sketchatone not found at $INSTALL_DIR"
        print_error "Please install sketchatone first"
        exit 1
    fi
}

# Extract vendor/product IDs from device config JSON files
# Returns lines in format: vendor_id:product_id:device_name
get_device_ids() {
    local devices_path="$1"
    
    if [ ! -d "$devices_path" ]; then
        return
    fi
    
    for config_file in "$devices_path"/*.json; do
        if [ -f "$config_file" ]; then
            # Extract vendorId and productId using grep/sed (works without jq)
            local vendor_id=$(grep -oP '"vendorId"\s*:\s*"\K[^"]+' "$config_file" 2>/dev/null | head -1)
            local product_id=$(grep -oP '"productId"\s*:\s*"\K[^"]+' "$config_file" 2>/dev/null | head -1)
            local name=$(grep -oP '"name"\s*:\s*"\K[^"]+' "$config_file" 2>/dev/null | head -1)
            
            if [ -n "$vendor_id" ] && [ -n "$product_id" ]; then
                # Remove 0x prefix if present
                vendor_id="${vendor_id#0x}"
                product_id="${product_id#0x}"
                echo "$vendor_id:$product_id:$name"
            fi
        fi
    done
}

# List available device configs
list_devices() {
    print_info "Scanning device configs in $DEVICES_DIR..."
    echo ""
    
    local found=0
    while IFS=: read -r vendor product name; do
        if [ -n "$vendor" ]; then
            echo "  ðŸ“± $name"
            echo "     Vendor ID:  0x$vendor"
            echo "     Product ID: 0x$product"
            echo ""
            found=$((found + 1))
        fi
    done < <(get_device_ids "$DEVICES_DIR")
    
    if [ $found -eq 0 ]; then
        print_warning "No device configs found in $DEVICES_DIR"
        echo "Add device JSON files with vendorId and productId fields"
    else
        print_info "Found $found device config(s)"
    fi
}

# Generate udev rules from device configs
generate_udev_rules() {
    print_info "Generating udev rules from device configs..."
    
    local rules=""
    local count=0
    
    # Add header
    rules+="# Sketchatone udev rules - Auto-generated by sketchatone-setup\n"
    rules+="# Do not edit manually - run 'sketchatone-setup --mode usb-trigger' to regenerate\n"
    rules+="\n"
    
    # Add HID permission rules and systemd trigger rules for each device
    while IFS=: read -r vendor product name; do
        if [ -n "$vendor" ]; then
            # HID permission rule (allow non-root access)
            rules+="# $name\n"
            rules+="SUBSYSTEM==\"hidraw\", ATTRS{idVendor}==\"$vendor\", ATTRS{idProduct}==\"$product\", MODE=\"0666\"\n"
            
            # USB add rule - trigger systemd service
            rules+="ACTION==\"add\", SUBSYSTEM==\"usb\", ATTR{idVendor}==\"$vendor\", ATTR{idProduct}==\"$product\", TAG+=\"systemd\", ENV{SYSTEMD_WANTS}=\"sketchatone.service\"\n"
            
            # USB remove rule - stop service
            rules+="ACTION==\"remove\", SUBSYSTEM==\"usb\", ENV{ID_VENDOR_ID}==\"$vendor\", ENV{ID_MODEL_ID}==\"$product\", RUN+=\"/bin/systemctl stop sketchatone.service\"\n"
            rules+="\n"
            
            count=$((count + 1))
        fi
    done < <(get_device_ids "$DEVICES_DIR")
    
    if [ $count -eq 0 ]; then
        print_error "No device configs found - cannot generate udev rules"
        print_error "Add device JSON files to $DEVICES_DIR"
        exit 1
    fi
    
    # Write rules file
    echo -e "$rules" > "$UDEV_RULES_FILE"
    print_success "Generated udev rules for $count device(s)"
    print_info "Rules written to: $UDEV_RULES_FILE"
}

# Remove udev rules
remove_udev_rules() {
    if [ -f "$UDEV_RULES_FILE" ]; then
        rm -f "$UDEV_RULES_FILE"
        print_info "Removed udev rules"
    fi
}

# Reload udev rules
reload_udev() {
    print_info "Reloading udev rules..."
    udevadm control --reload-rules
    udevadm trigger
    print_success "udev rules reloaded"
}

# Configure USB-triggered mode
setup_usb_trigger() {
    print_info "Configuring USB-triggered mode..."
    echo ""
    
    # Stop and disable always-on service
    if systemctl is-active --quiet sketchatone 2>/dev/null; then
        systemctl stop sketchatone
    fi
    if systemctl is-enabled --quiet sketchatone 2>/dev/null; then
        systemctl disable sketchatone
    fi
    
    # Generate udev rules
    generate_udev_rules
    reload_udev
    
    echo ""
    print_success "USB-triggered mode configured!"
    echo ""
    echo "  â€¢ Sketchatone will start automatically when a supported tablet is plugged in"
    echo "  â€¢ Sketchatone will stop when the tablet is unplugged"
    echo "  â€¢ Zero resource usage when tablet is not connected"
    echo ""
    echo "To test: Plug in your tablet and check status with:"
    echo "  systemctl status sketchatone"
}

# Configure always-on mode
setup_always_on() {
    print_info "Configuring always-on mode..."
    echo ""
    
    # Remove USB trigger rules (keep permission rules)
    if [ -f "$UDEV_RULES_FILE" ]; then
        # Generate permission-only rules
        local rules=""
        rules+="# Sketchatone udev rules - HID permissions only\n"
        rules+="\n"
        
        while IFS=: read -r vendor product name; do
            if [ -n "$vendor" ]; then
                rules+="# $name\n"
                rules+="SUBSYSTEM==\"hidraw\", ATTRS{idVendor}==\"$vendor\", ATTRS{idProduct}==\"$product\", MODE=\"0666\"\n"
            fi
        done < <(get_device_ids "$DEVICES_DIR")
        
        echo -e "$rules" > "$UDEV_RULES_FILE"
        reload_udev
    fi
    
    # Enable and start service
    systemctl enable sketchatone
    systemctl start sketchatone
    
    echo ""
    print_success "Always-on mode configured!"
    echo ""
    echo "  â€¢ Sketchatone will start automatically on system boot"
    echo "  â€¢ Service is now running"
    echo ""
    echo "Check status with:"
    echo "  systemctl status sketchatone"
}

# Configure manual mode
setup_manual() {
    print_info "Configuring manual mode..."
    echo ""
    
    # Stop and disable service
    if systemctl is-active --quiet sketchatone 2>/dev/null; then
        systemctl stop sketchatone
    fi
    if systemctl is-enabled --quiet sketchatone 2>/dev/null; then
        systemctl disable sketchatone
    fi
    
    # Keep permission rules but remove trigger rules
    if [ -f "$UDEV_RULES_FILE" ]; then
        local rules=""
        rules+="# Sketchatone udev rules - HID permissions only\n"
        rules+="\n"
        
        while IFS=: read -r vendor product name; do
            if [ -n "$vendor" ]; then
                rules+="# $name\n"
                rules+="SUBSYSTEM==\"hidraw\", ATTRS{idVendor}==\"$vendor\", ATTRS{idProduct}==\"$product\", MODE=\"0666\"\n"
            fi
        done < <(get_device_ids "$DEVICES_DIR")
        
        echo -e "$rules" > "$UDEV_RULES_FILE"
        reload_udev
    fi
    
    echo ""
    print_success "Manual mode configured!"
    echo ""
    echo "  â€¢ Sketchatone will NOT start automatically"
    echo "  â€¢ Run manually with: sketchatone"
    echo "  â€¢ Or start service with: sudo systemctl start sketchatone"
}

# Show current status
show_status() {
    echo ""
    echo "=========================================="
    echo "Sketchatone Configuration Status"
    echo "=========================================="
    echo ""
    
    # Check installation
    if [ -d "$INSTALL_DIR" ]; then
        print_success "Installation: Found at $INSTALL_DIR"
    else
        print_error "Installation: NOT FOUND"
        return
    fi
    
    # Check config
    if [ -f "$CONFIG_DIR/config.json" ]; then
        print_success "Config: $CONFIG_DIR/config.json"
    else
        print_warning "Config: Not found (using defaults)"
    fi
    
    # Check device configs
    local device_count=0
    while IFS=: read -r vendor product name; do
        [ -n "$vendor" ] && device_count=$((device_count + 1))
    done < <(get_device_ids "$DEVICES_DIR")
    
    if [ $device_count -gt 0 ]; then
        print_success "Device configs: $device_count found"
    else
        print_warning "Device configs: None found"
    fi
    
    # Check service status
    echo ""
    if systemctl is-enabled --quiet sketchatone 2>/dev/null; then
        print_info "Service: Enabled (starts on boot)"
    else
        print_info "Service: Disabled (manual start)"
    fi
    
    if systemctl is-active --quiet sketchatone 2>/dev/null; then
        print_success "Service: Running"
    else
        print_info "Service: Stopped"
    fi
    
    # Check udev rules
    echo ""
    if [ -f "$UDEV_RULES_FILE" ]; then
        if grep -q "SYSTEMD_WANTS" "$UDEV_RULES_FILE" 2>/dev/null; then
            print_success "Mode: USB-triggered (starts when tablet plugged in)"
        else
            print_info "Mode: Permission rules only"
        fi
    else
        print_info "Mode: No udev rules configured"
    fi
    
    echo ""
}

# Main
case "${1:-}" in
    --mode)
        check_root
        check_installed
        case "${2:-}" in
            usb-trigger)
                setup_usb_trigger
                ;;
            always-on)
                setup_always_on
                ;;
            manual)
                setup_manual
                ;;
            *)
                print_error "Invalid mode: ${2:-<empty>}"
                echo "Valid modes: usb-trigger, always-on, manual"
                exit 1
                ;;
        esac
        ;;
    --list-devices)
        check_installed
        list_devices
        ;;
    --status)
        check_installed
        show_status
        ;;
    --help|-h|"")
        show_usage
        ;;
    *)
        print_error "Unknown option: $1"
        show_usage
        exit 1
        ;;
esac
